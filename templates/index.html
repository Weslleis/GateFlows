<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Controle de Acesso</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />

    <script>
        // Função para formatar o CPF
        function formatarCPF(campo) {
            let valor = campo.value.replace(/\D/g, '');
            if (valor.length > 11) valor = valor.slice(0, 11);

            let formatado = '';
            if (valor.length > 9) {
                formatado = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (valor.length > 6) {
                formatado = valor.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (valor.length > 3) {
                formatado = valor.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            } else {
                formatado = valor;
            }
            campo.value = formatado;
        }

        // Função para validar o CPF
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;

            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;

            return resto === parseInt(cpf.charAt(10));
        }

        // Função para validar a placa (Mercosul ou Nacional)
        function validarPlaca(placa) {
            // Remove espaços e hífens para validação interna
            placa = placa.replace(/[- ]/g, '').toUpperCase();
            // Regex para formato Mercosul: ABC1B10 (7 caracteres)
            const regexPlacaMercosul = /^[A-Z]{3}\d[A-Z]{1}\d{2}$/;
            // Regex para formato Nacional: ABC1234 (7 caracteres)
            const regexPlacaNacional = /^[A-Z]{3}\d{4}$/;
            return regexPlacaMercosul.test(placa) || regexPlacaNacional.test(placa);
        }

        // Função para formatar a placa
        function formatarPlaca(campo) {
            let valor = campo.value.toUpperCase();
            valor = valor.replace(/[^A-Z0-9]/g, ''); // Remove tudo que não for letra/número

            // Adiciona o hífen se a placa tiver 7 caracteres e seguir um dos formatos esperados
            if (valor.length === 7) {
                // Formato Nacional: ABC1234 -> ABC-1234
                if (/^[A-Z]{3}\d{4}$/.test(valor)) {
                    valor = valor.replace(/([A-Z]{3})(\d{4})/, '$1-$2');
                }
                // Formato Mercosul: ABC1B23 -> ABC-1B23
                else if (/^[A-Z]{3}\d[A-Z]{1}\d{2}$/.test(valor)) {
                    valor = valor.replace(/([A-Z]{3})(\d)([A-Z]{1})(\d{2})/, '$1-$2$3$4');
                }
            }
            campo.value = valor;
        }

        // Validação visual ao sair do campo CPF
        function aoSairDoCampoCPF() {
            const campo = document.getElementById("cpf");
            const cpfErro = document.getElementById("cpf-erro");
            if (!validarCPF(campo.value)) {
                campo.style.border = "2px solid red";
                cpfErro.style.display = "block"; // Torna visível
            } else {
                campo.style.border = "";
                cpfErro.style.display = "none"; // Esconde
            }
        }

        // Validação visual ao sair do campo Placa
        function aoSairDoCampoPlaca() {
            const campo = document.getElementById("placa");
            const placaErro = document.getElementById("placa-erro");
            if (!validarPlaca(campo.value)) {
                campo.style.border = "2px solid red";
                placaErro.style.display = "block"; // Torna visível
            } else {
                campo.style.border = "";
                placaErro.style.display = "none"; // Esconde
            }
        }

        // Limpa erro da placa ao digitar
        function limparErroPlaca() {
            const campo = document.getElementById("placa");
            campo.style.border = "";
            document.getElementById("placa-erro").style.display = "none";
        }

        // Navegar com Enter até o próximo campo
        function navegarComEnter(event, proximoCampo) {
            if (event.key === "Enter") {
                event.preventDefault();
                proximoCampo.focus();
            }
        }

        // Envia o formulário ao pressionar Enter no último campo (observação)
        function enviarFormulario(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.querySelector("form").submit();
            }
        }

        // Validação geral no submit
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelector('form').addEventListener('submit', function(e) {
                const cpfInput = document.getElementById('cpf');
                const placaInput = document.getElementById('placa');
                let valid = true;

                // Re-valida CPF e Placa no submit e mostra os erros locais
                if (!validarCPF(cpfInput.value)) {
                    cpfInput.style.border = '2px solid red';
                    document.getElementById('cpf-erro').style.display = 'block'; // Mostra o erro
                    valid = false;
                } else {
                    cpfInput.style.border = ''; // Limpa borda se válido
                    document.getElementById('cpf-erro').style.display = 'none'; // Esconde o erro
                }

                if (!validarPlaca(placaInput.value)) {
                    placaInput.style.border = '2px solid red';
                    document.getElementById('placa-erro').style.display = 'block'; // Mostra o erro
                    valid = false;
                } else {
                    placaInput.style.border = ''; // Limpa borda se válido
                    document.getElementById('placa-erro').style.display = 'none'; // Esconde o erro
                }
                
                if (!valid) {
                    e.preventDefault(); // Impede o envio se houver erro
                }
            });

            // Script para esconder mensagens flash automaticamente (do Flask)
            const flashMessages = document.querySelectorAll('.flash');
            flashMessages.forEach(message => {
                // Verifica se a mensagem flash não é uma das mensagens de erro locais
                // Adicionado para evitar que o script esconda as mensagens de erro locais
                if (message.id !== 'cpf-erro' && message.id !== 'placa-erro') {
                    setTimeout(() => {
                        message.classList.add('hide');
                    }, 3000);
                }
            });
        });
    </script>
</head>
<body>
    <h1>Registro de Acesso de Fornecedores</h1>

    {# Bloco para exibir as mensagens flash do Flask #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <form method="POST">
        <label for="data">Data:</label>
        {# NOVO: Adicionado 'value="{{ data or today }}"' para setar a data do dia #}
        {# 'required' garante que o navegador avise se estiver vazio #}
        <input type="date" name="data" value="{{ data or today }}" onkeydown="navegarComEnter(event, document.getElementsByName('hora_entrada')[0])" required><br><br>
        
        <label for="hora_entrada">Hora Entrada:</label>
        {# 'required' adicionado #}
        <input type="time" name="hora_entrada" value="{{ hora_entrada or '' }}" onkeydown="navegarComEnter(event, document.getElementsByName('fornecedor')[0])" required><br><br>
        
        <label for="fornecedor">Fornecedor:</label>
        {# 'required' adicionado #}
        <input type="text" name="fornecedor" value="{{ fornecedor or '' }}" onkeydown="navegarComEnter(event, document.getElementsByName('nome_motorista')[0])" required><br><br>
        
        <label for="nome_motorista">Nome Motorista:</label>
        {# 'required' adicionado #}
        <input type="text" name="nome_motorista" value="{{ nome_motorista or '' }}" onkeydown="navegarComEnter(event, document.getElementById('cpf'))" required><br><br>
        
        <label for="cpf">CPF:</label>
        {# 'required' adicionado #}
        <input type="text" name="cpf" id="cpf" maxlength="14"
                value="{{ cpf or '' }}" {# Adicionado 'value' #}
                oninput="formatarCPF(this)" onblur="aoSairDoCampoCPF()" onkeydown="navegarComEnter(event, document.getElementById('placa'))" required><br><br>
        
        <div id="cpf-erro" class="flash danger" style="display: none;">CPF inválido! Corrija o CPF.</div>
        
        <label for="placa">Placa Caminhão:</label>
        {# 'required' adicionado #}
        <input type="text" name="placa" id="placa" maxlength="8"
                value="{{ placa or '' }}" {# Adicionado 'value' #}
                oninput="formatarPlaca(this); limparErroPlaca()" onblur="aoSairDoCampoPlaca()" onkeydown="navegarComEnter(event, document.getElementsByName('hora_saida')[0])" required><br><br>

        <div id="placa-erro" class="flash danger" style="display: none;">Placa inválida! O formato correto é: ABC-1234 ou ABC-1B10.</div>
        
        <label for="hora_saida">Hora Saída:</label>
        {# Este campo NÃO TEM 'required' #}
        <input type="time" name="hora_saida" value="{{ hora_saida or '' }}" onkeydown="navegarComEnter(event, document.getElementsByName('observacao')[0])"><br><br>
        
        <label for="observacao">Observação:</label>
        {# Este campo NÃO TEM 'required' #}
        <textarea name="observacao" onkeydown="enviarFormulario(event)">{{ observacao or '' }}</textarea><br><br>

        <div class="botao-container">
            <button type="submit">Salvar</button>
            <a href="{{ url_for('registros') }}" class="registros-button">Ver Registros Salvos</a>
        </div>

    </form>
</body>
</html>